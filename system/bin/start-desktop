#!/bin/bash
set -e

# NOTE: This script requires the following:
#
# For xorg sessions:
# - xorg.service
# - $session-session.target
#
# For wayland sessions:
# - $session.service
# - $session-session.target

# Check that we have a session
session="${1:-default}"
if [ -z "$session" ]; then
    printf "No graphical session given\n"
    exit 1
fi

# Check that we have a VT
if [ -z "${XDG_VTNR}" ]; then
    printf "XDG_VTNR variable is not set. Desktop sessions must be launched from a physical tty\n"
    exit 1
fi

# Check that we have a runtime directory
if [ -z "${XDG_RUNTIME_DIR}" ]; then
    pritnf "XDG_RUNTIME_DIR variable not set\n"
    exit 1
fi

WAYLAND_SESSIONS=('sway')

for item in "${WAYLAND_SESSIONS[@]}"; do
    if [ "$item" = "$session" ]; then
        export WAYLAND_DISPLAY="wayland-${XDG_VTNR}"
    fi
done

# NOTE: sway hangs if DISPLAY is set.
if [ -z "${WAYLAND_DISPLAY}" ]; then
    export DISPLAY=:${XDG_VTNR}
    export XAUTHORITY="$XDG_RUNTIME_DIR/xorg/Xauthority"
fi

systemctl --user import-environment DISPLAY XDG_VTNR XDG_SEAT XDG_SESSION_ID XAUTHORITY WAYLAND_DISPLAY

# Start desktop session
systemctl --user start "${session}-session.target"

# Start device configuration target
# chassis=$(hostnamectl status | awk '/Chassis/{print $2}')
# case "$chassis" in
#     tablet)  systemctl --user start tablet.target ;;
#     laptop)  systemctl --user start laptop.target ;;
#     desktop) systemctl --user start desktop.target ;;
#     *)       systemctl --user start desktop.target ;;
# esac

# Wait synchronously until the xorg server stops
if [ -n "$WAYLAND_DISPLAY" ]; then
    systemctl --user start --wait "$session.service"
else
    systemctl --user start --wait xorg.service
fi

# Unset environment
systemctl --user unset-environment DISPLAY XDG_VTNR XDG_SEAT XDG_SESSION_ID XAUTHORITY WAYLAND_DISPLAY
unset DISPLAY XAUTHORITY WAYLAND_DISPLAY

# Reset tty and colors
reset

# NOTE: we abuse /etc/issue to change the tty colors.
sed -e 's/\\\\/\\/g' -e 's/\\[a-z].*$//g' /etc/issue
