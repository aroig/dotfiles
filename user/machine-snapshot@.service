[Unit]
Description=create an ephimeral disk snapshot for %i vm

[Service]
Type=oneshot
RemainAfterExit=true

Slice=machines.slice

Environment=IMAGE=/home/abdo/virt/qemu/%i.qcow2 SNAPSHOT=/home/abdo/virt/tmp/%i-snapshot.qcow2

ExecStartPre=/usr/bin/mkdir -m 777 ${IMAGE}.lck
ExecStart=/usr/bin/qemu-img create -f qcow2 -o backing_file=${IMAGE} ${SNAPSHOT}

ExecStop=/usr/bin/rm ${SNAPSHOT}
ExecStopPost=/usr/bin/rmdir ${IMAGE}.lck
